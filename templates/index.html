<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantpedia Strategy Screener</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        .filter-section { transition: all 0.3s ease; }
        .strategy-card { transition: transform 0.2s ease; }
        .strategy-card:hover { transform: translateY(-2px); }
        .summary-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .summary-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Quantpedia Strategy Screener</h1>
            <p class="text-gray-600">Discover and analyze investment strategies</p>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex space-x-4 mb-6">
                <div class="relative flex-grow">
                    <input type="text" id="search" placeholder="Search strategies..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
                <div class="relative w-64">
                    <select id="sort-by" class="block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md leading-5 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="sharpe">Sort by Sharpe Ratio ↓</option>
                        <option value="date">Sort by Date ↓</option>
                        <option value="title">Sort by Title</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div class="filter-section">
                    <h3 class="text-lg font-semibold mb-2">Trading Style</h3>
                    <p class="text-sm text-gray-600 mb-3">Select multiple to see strategies matching any of these styles</p>
                    <div class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-momentum" value="momentum" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-momentum" class="ml-2 text-sm text-gray-700">Momentum (256)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-momentum-in-stocks" value="momentum-in-stocks" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-momentum-in-stocks" class="ml-2 text-sm text-gray-700">Momentum in Stocks (106)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-volatility-effect" value="volatility-effect" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-volatility-effect" class="ml-2 text-sm text-gray-700">Volatility Effect (102)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-reversal" value="reversal" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-reversal" class="ml-2 text-sm text-gray-700">Reversal (99)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-trend-following" value="trend-following" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-trend-following" class="ml-2 text-sm text-gray-700">Trend Following (82)</label>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="text-lg font-semibold mb-2">Factor Type</h3>
                    <p class="text-sm text-gray-600 mb-3">Select multiple to see strategies matching any of these factors</p>
                    <div class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-value" value="value" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-value" class="ml-2 text-sm text-gray-700">Value (64)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-liquidity-risk-premium" value="liquidity-risk-premium" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-liquidity-risk-premium" class="ml-2 text-sm text-gray-700">Liquidity Risk Premium (23)</label>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="text-lg font-semibold mb-2">Popular Categories</h3>
                    <p class="text-sm text-gray-600 mb-3">Select multiple to see strategies from any of these categories</p>
                    <div class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-factor-investing" value="factor-investing" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-factor-investing" class="ml-2 text-sm text-gray-700">Factor Investing (533)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-smart-beta" value="smart-beta" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-smart-beta" class="ml-2 text-sm text-gray-700">Smart Beta (481)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-equity-long-short" value="equity-long-short" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-equity-long-short" class="ml-2 text-sm text-gray-700">Equity Long Short (469)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-stock-picking" value="stock-picking" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-stock-picking" class="ml-2 text-sm text-gray-700">Stock Picking (414)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="keyword-market-timing" value="market-timing" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded keyword-filter">
                            <label for="keyword-market-timing" class="ml-2 text-sm text-gray-700">Market Timing (220)</label>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="text-lg font-semibold mb-2">Asset Classes</h3>
                    <p class="text-sm text-gray-600 mb-3">Select multiple to see strategies for any of these assets</p>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="asset-stocks" value="stocks" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded asset-filter">
                            <label for="asset-stocks" class="ml-2 text-sm text-gray-700">Stocks</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="asset-bonds" value="bonds" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded asset-filter">
                            <label for="asset-bonds" class="ml-2 text-sm text-gray-700">Bonds</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="asset-forex" value="forex" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded asset-filter">
                            <label for="asset-forex" class="ml-2 text-sm text-gray-700">Forex</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="asset-crypto" value="crypto" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded asset-filter">
                            <label for="asset-crypto" class="ml-2 text-sm text-gray-700">Crypto</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Strategy cards will be dynamically inserted here -->
        </div>

        <!-- Strategy Modal -->
        <div id="strategy-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto">
            <div class="relative top-10 mx-auto p-6 border w-11/12 md:w-3/4 lg:w-4/5 shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
                <div class="mt-3">
                    <h3 class="text-xl leading-6 font-bold text-gray-900 mb-4" id="modal-title"></h3>
                    <div class="mt-2">
                        <div id="modal-loading" class="text-center py-4 hidden">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                            <p class="mt-2 text-sm text-gray-500">Generating summaries...</p>
                        </div>
                        <div id="modal-error" class="hidden">
                            <p class="text-sm text-red-600" id="modal-error-message"></p>
                        </div>
                        <div id="modal-summary" class="summary-container">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 id="primary-model-label" class="text-lg font-semibold mb-3 text-blue-800">GPT-OSS 120B Analysis</h4>
                                <div id="openai-summary" class="prose max-w-none"></div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h4 id="secondary-model-label" class="text-lg font-semibold mb-3 text-purple-800">Kimi K2 Instruct (1T) Analysis</h4>
                                <div id="anthropic-summary" class="prose max-w-none"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button type="button" onclick="closeModal()" 
                                class="w-full inline-flex justify-center px-4 py-2 text-sm font-medium text-blue-900 bg-blue-100 border border-transparent rounded-md hover:bg-blue-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let debounceTimer;
        const modal = document.getElementById("strategy-modal");
        const modalLoading = document.getElementById("modal-loading");
        const modalError = document.getElementById("modal-error");
        const modalErrorMessage = document.getElementById("modal-error-message");
        const modalSummary = document.getElementById("modal-summary");
        const openaiSummary = document.getElementById("openai-summary");
        const anthropicSummary = document.getElementById("anthropic-summary");
        const primaryModelLabelEl = document.getElementById("primary-model-label");
        const secondaryModelLabelEl = document.getElementById("secondary-model-label");

        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(debounceTimer);
                    func(...args);
                };
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(later, wait);
            };
        }

        function showError(message) {
            modalLoading.classList.add("hidden");
            modalError.classList.remove("hidden");
            modalErrorMessage.textContent = message;
            modalSummary.classList.add("hidden");
        }

        function showLoading() {
            modalLoading.classList.remove("hidden");
            modalError.classList.add("hidden");
            modalSummary.classList.add("hidden");
        }

        function formatSummary(text) {
            return text
                .replace(/^#+ (.*?)$/gm, "<h3 class=\"text-lg font-semibold mt-4 mb-2\">$1</h3>")
                .replace(/^\d+\. (.*?)$/gm, "<h3 class=\"text-lg font-semibold mt-4 mb-2\">$1</h3>")
                .replace(/^- (.*?)$/gm, "<li class=\"ml-4\">$1</li>")
                .replace(/\n\n/g, "</p><p class=\"my-2\">")
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        }

        function showSummaries(openaiText, anthropicText) {
            modalLoading.classList.add("hidden");
            modalError.classList.add("hidden");
            modalSummary.classList.remove("hidden");
            openaiSummary.innerHTML = formatSummary(openaiText || "Summary not available");
            anthropicSummary.innerHTML = formatSummary(anthropicText || "Summary not available");
        }

        function refreshModelLabels() {
            fetch('/api/models', { cache: 'no-store' })
                .then(r => r.json())
                .then(models => {
                    if (models && models.primary && models.primary.label && primaryModelLabelEl) {
                        primaryModelLabelEl.textContent = `${models.primary.label} Analysis`;
                    }
                    if (models && models.secondary && models.secondary.label && secondaryModelLabelEl) {
                        secondaryModelLabelEl.textContent = `${models.secondary.label} Analysis`;
                    }
                })
                .catch(err => {
                    console.warn('Unable to load model labels', err);
                });
        }

        function getFilters() {
            const selectedKeywords = Array.from(document.querySelectorAll(".keyword-filter:checked"))
                .map(checkbox => checkbox.value.replace(/-/g, ' ').toLowerCase());

            const selectedAssets = Array.from(document.querySelectorAll(".asset-filter:checked"))
                .map(checkbox => checkbox.value);

            const filters = {
                search: document.getElementById("search").value,
                sort_by: document.getElementById("sort-by").value
            };

            if (selectedAssets.length > 0) {
                filters["asset_classes[]"] = selectedAssets;
            }

            if (selectedKeywords.length > 0) {
                filters["keywords[]"] = selectedKeywords;
            }

            return filters;
        }

        function updateResults() {
            const filters = getFilters();
            console.log("Applying filters:", filters);
            const queryString = new URLSearchParams(Object.entries(filters).filter(([_, v]) => v !== null && v !== "")).toString();
            
            fetch(`/api/strategies?${queryString}`)
                .then(response => response.json())
                .then(strategies => {
                    console.log("Received strategies:", strategies.length);
                    const resultsDiv = document.getElementById("results");
                    resultsDiv.innerHTML = strategies.map(strategy => `
                        <div class="strategy-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg flex flex-col h-full">
                            <div class="flex-grow">
                                <h3 class="text-xl font-semibold mb-2">${strategy.title}</h3>
                                <div class="text-sm text-gray-600 mb-4">
                                    <p><i class="fas fa-chart-line mr-2"></i>Sharpe: ${strategy.performance_metrics?.sharpe_ratio || "N/A"}</p>
                                    <p><i class="fas fa-clock mr-2"></i>Trading Frequency: ${strategy.implementation?.trading_frequency || "N/A"}</p>
                                    <p><i class="fas fa-calendar mr-2"></i>End Year: ${strategy.end_year || "N/A"}</p>
                                </div>
                                <div class="mb-4 flex flex-wrap gap-2">
                                    ${(strategy.keywords || []).map(keyword => 
                                        `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700">
                                            <i class="fas fa-tag mr-1"></i>${keyword.replace(/-/g, " ")}
                                        </span>`
                                    ).join("")}
                                </div>
                            </div>
                            <div class="flex gap-4 justify-center items-center mt-auto pt-4">
                                <button onclick="showSummaryModal('${strategy.filename}', '${strategy.title}')" class="inline-flex items-center px-6 py-2.5 text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-chart-bar mr-2"></i>Summarize
                                </button>
                                <button onclick="viewStrategyContent('${strategy.filename.replace('.json', '')}')" class="inline-flex items-center px-6 py-2.5 text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-eye mr-2"></i>View
                                </button>
                            </div>
                        </div>
                    `).join("");
                })
                .catch(error => {
                    console.error("Error fetching strategies:", error);
                });
        }

        function showSummaryModal(filename, title) {
            const modalTitle = document.getElementById("modal-title");
            
            modal.classList.remove("hidden");
            modalTitle.textContent = title;
            showLoading();
            // Ensure labels reflect latest runtime configuration
            refreshModelLabels();
            
            fetch(`/api/strategy/${filename}/summary`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    showSummaries(data.openai_summary, data.anthropic_summary);
                })
                .catch(error => {
                    console.error("Error:", error);
                    showError(error.message);
                });
        }

        function closeModal() {
            modal.classList.add("hidden");
        }

        function viewStrategyContent(filename) {
            window.open(`/api/strategy/${filename}/content`, '_blank');
        }

        // Event listeners
        document.getElementById("search").addEventListener("input", debounce(updateResults, 300));
        document.getElementById("sort-by").addEventListener("change", updateResults);
        
        // Asset class filters
        document.querySelectorAll(".asset-filter").forEach(checkbox => {
            checkbox.addEventListener("change", updateResults);
        });
        
        // Keyword filters
        document.querySelectorAll(".keyword-filter").forEach(checkbox => {
            checkbox.addEventListener("change", updateResults);
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initial load
        updateResults();
        refreshModelLabels();
    </script>
</body>
</html>
